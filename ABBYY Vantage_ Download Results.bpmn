<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Web Modeler" exporterVersion="8a59953" modeler:executionPlatform="Camunda Cloud" modeler:executionPlatformVersion="8.8.0">
  <bpmn:process id="ABBYY_Vantage_Download_Results" name="ABBYY Vantage - Download Results" isExecutable="true">
    <bpmn:extensionElements>
      <zeebe:properties>
        <zeebe:property name="ProcessedTransaction" value="ProcessedTransaction" />
        <zeebe:property name="Transaction Result Files" value="ResultFiles_Vantage" />
      </zeebe:properties>
    </bpmn:extensionElements>
    <bpmn:endEvent id="Event_187" name="End">
      <bpmn:extensionElements />
      <bpmn:incoming>Flow_0isrmz3</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0isrmz3" sourceRef="ProcessingResults.DocumentsActivity" targetRef="Event_187" />
    <bpmn:sequenceFlow id="Flow_1w7dwe7" sourceRef="StartEvent_11" targetRef="ProcessingResults.DocumentsActivity" />
    <bpmn:subProcess id="ProcessingResults.DocumentsActivity" name="For each Document in ProcessingResults.Documents">
      <bpmn:extensionElements />
      <bpmn:incoming>Flow_1w7dwe7</bpmn:incoming>
      <bpmn:outgoing>Flow_0isrmz3</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true">
        <bpmn:extensionElements>
          <zeebe:loopCharacteristics inputCollection="=transactionInfo.documents" inputElement="document" outputCollection="outputFiles" outputElement="=downloadedResultFilesList" />
        </bpmn:extensionElements>
      </bpmn:multiInstanceLoopCharacteristics>
      <bpmn:startEvent id="Event_0cshg" name="Download Document Result Files">
        <bpmn:extensionElements />
        <bpmn:outgoing>Flow_0ytod6p</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:sequenceFlow id="Flow_0ixort9" sourceRef="Document.resultFilesActivity" targetRef="Event_0b60" />
      <bpmn:sequenceFlow id="Flow_0ytod6p" sourceRef="Event_0cshg" targetRef="Document.resultFilesActivity" />
      <bpmn:subProcess id="Document.resultFilesActivity" name="For each resultFile in Document.resultFiles">
        <bpmn:extensionElements />
        <bpmn:incoming>Flow_0ytod6p</bpmn:incoming>
        <bpmn:outgoing>Flow_0ixort9</bpmn:outgoing>
        <bpmn:multiInstanceLoopCharacteristics isSequential="true">
          <bpmn:extensionElements>
            <zeebe:loopCharacteristics inputCollection="=document.resultFiles" inputElement="resultFileMetadata" outputCollection="downloadedResultFilesList" outputElement="=context put (downloadedDocument, &#34;metadata&#34;, context merge(downloadedDocument.metadata,{&#10;      &#34;fileName&#34;: resultFileMetadata.fileName&#10;  })&#10;)&#10;&#10;  " />
          </bpmn:extensionElements>
        </bpmn:multiInstanceLoopCharacteristics>
        <bpmn:serviceTask id="Download_Result_File" name="Download Result File" zeebe:modelerTemplate="ABBYY_Vantage_Connector" zeebe:modelerTemplateVersion="8" zeebe:modelerTemplateIcon="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNDI5LjU5IDQzMC4xIj4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjZmYyMDM4OwogICAgICB9CiAgICA8L3N0eWxlPgogIDwvZGVmcz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Im0xMzQwLjI4LDBsLTMwLjMsMTM4Ljc2Yy00Ljc4LDIxLjI3LTcuOTcsNDEuNDctMTIuMjMsNzAuNzFoLTIuNjZjLTQuMjUtMjkuMjQtNy40NC00OS40NC0xMi4yMy03MC43MUwxMjUyLjU2LDBoLTk1LjE2bDkxLjQ0LDMwMC45MXYxMjkuMTloODkuMzJ2LTEyOS4xOUwxNDI5LjU5LDBoLTg5LjMyWiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0ibTEwMzIuNDUsMTM4Ljc2Yy00Ljc4LDIxLjI3LTcuOTcsNDEuNDctMTIuMjMsNzAuNzFoLTIuNjZjLTQuMjUtMjkuMjQtNy40NC00OS40NC0xMi4yMy03MC43MUw5NzUuMDQsMGgtOTUuMTZsOTEuNDQsMzAwLjkxdjEyOS4xOWg4OS4zMnYtMTI5LjE5TDExNTIuMDcsMGgtODkuMzJsLTMwLjMsMTM4Ljc2WiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0ibTIwNy4zNCwwaC0xMTkuMDlMMCw0MzAuMWg5MC4zOGwxNS4xNC05Ny4yOWg4MC44M2wxNS4xNCw5Ny4yOWg5NC4xTDIwNy4zNCwwWm0tOTAuOSwyNjIuNjNsMjAuMTktMTI5LjcyYzMuMTktMjAuMiw1LjMyLTM5Ljg3LDcuOTctNjcuNTJoMi42NmMyLjY2LDI3LjY1LDQuNzgsNDcuMzIsNy45Nyw2Ny41MmwyMC4xOSwxMjkuNzJoLTU4Ljk5WiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0ibTUxNy44MiwyMDEuNDl2LS41M2MzMC44NC0xMC42Myw1Mi42My00Mi41Myw1Mi42My04OC4yNSwwLTY5LjExLTM5LjM0LTExMi43MS0xMjMuMzQtMTEyLjcxaC0xMTkuNjJ2NDMwLjFoMTI3LjA2Yzg2LjEzLDAsMTI1LjQ3LTQ2Ljc4LDEyNS40Ny0xMjQuNCwwLTU5LjU0LTI0LjQ2LTkwLjkxLTYyLjItMTA0LjJabS0xMDMuMTQtMTM5LjI5aDI0LjQ2YzI4LjcxLDAsNDMuMDYsMTYuNDgsNDMuMDYsNTguNDhzLTE0LjM1LDU4LjQ4LTQzLjA2LDU4LjQ4aC0yNC40NlY2Mi4yWm0zMS45LDMwNS43aC0zMS45di0xMjguNjZoMzEuOWMyOS4yNCwwLDQyLjUzLDE4LjYxLDQyLjUzLDY0LjMzcy0xMy4yOSw2NC4zMy00Mi41Myw2NC4zM1oiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Im04MTQuNDgsMjAxLjQ5di0uNTNjMzAuODQtMTAuNjMsNTIuNjMtNDIuNTMsNTIuNjMtODguMjUsMC02OS4xMS0zOS4zNC0xMTIuNzEtMTIzLjM0LTExMi43MWgtMTE5LjYydjQzMC4xaDEyNy4wNmM4Ni4xMywwLDEyNS40Ny00Ni43OCwxMjUuNDctMTI0LjQsMC01OS41NC0yNC40Ni05MC45MS02Mi4yLTEwNC4yWm0tMTAzLjE0LTEzOS4yOWgyNC40NmMyOC43MSwwLDQzLjA2LDE2LjQ4LDQzLjA2LDU4LjQ4cy0xNC4zNSw1OC40OC00My4wNiw1OC40OGgtMjQuNDZWNjIuMlptMzEuOSwzMDUuN2gtMzEuOXYtMTI4LjY2aDMxLjljMjkuMjQsMCw0Mi41MywxOC42MSw0Mi41Myw2NC4zM3MtMTMuMjksNjQuMzMtNDIuNTMsNjQuMzNaIi8+Cjwvc3ZnPg==">
          <bpmn:extensionElements>
            <zeebe:taskDefinition type="io.camunda:http-json:1" retries="3" />
            <zeebe:ioMapping>
              <zeebe:input source="downloads_the_result_files__vantage_public_api___code_flow_auth_transactions_downloads_the_result_files" target="operationId" />
              <zeebe:input source="oauth-client-credentials-flow" target="authType" />
              <zeebe:input source="oauth-client-credentials-flow" target="authentication.type" />
              <zeebe:input source="=&#34;{{secrets.ABBYY_VANTAGE_BASE_URL}}/auth2/connect/token&#34;" target="authentication.oauthTokenEndpoint" />
              <zeebe:input source="{{secrets.ABBYY_VANTAGE_CLIENT_ID}}" target="authentication.clientId" />
              <zeebe:input source="{{secrets.ABBYY_VANTAGE_CLIENT_SECRET}}" target="authentication.clientSecret" />
              <zeebe:input source="basicAuthHeader" target="authentication.clientAuthentication" />
              <zeebe:input source="openid permissions global.wildcard" target="authentication.scopes" />
              <zeebe:input source="{{secrets.ABBYY_VANTAGE_BASE_URL}}" target="baseUrl" />
              <zeebe:input source="application/octet-stream" target="Accept" />
              <zeebe:input source="=resultFileMetadata.fileId" target="fileId" />
              <zeebe:input source="=transactionInfo.transactionID" target="transactionId" />
              <zeebe:input source="=&#34;&#34;+baseUrl+&#34;/api/publicapi/v1/transactions/&#34;+transactionId+&#34;/files/&#34;+fileId+&#34;/download&#34;" target="operationPath" />
              <zeebe:input source="={Accept: Accept}" target="headers" />
              <zeebe:input source="={}" target="queryParameters" />
              <zeebe:input source="GET" target="method" />
              <zeebe:input source="= operationPath" target="url" />
              <zeebe:input source="=true" target="storeResponse" />
            </zeebe:ioMapping>
            <zeebe:taskHeaders>
              <zeebe:header key="resultExpression" value="={&#10;  downloadedDocument: response.document&#10;}" />
              <zeebe:header key="retryBackoff" value="PT0S" />
            </zeebe:taskHeaders>
          </bpmn:extensionElements>
          <bpmn:incoming>Flow_1vxn1nt</bpmn:incoming>
          <bpmn:outgoing>Flow_0get4cm</bpmn:outgoing>
        </bpmn:serviceTask>
        <bpmn:startEvent id="Event_0exe0" name="Download using File ID">
          <bpmn:extensionElements />
          <bpmn:outgoing>Flow_1vxn1nt</bpmn:outgoing>
        </bpmn:startEvent>
        <bpmn:sequenceFlow id="Flow_0get4cm" sourceRef="Download_Result_File" targetRef="Event_1mlp" />
        <bpmn:sequenceFlow id="Flow_1vxn1nt" sourceRef="Event_0exe0" targetRef="Download_Result_File" />
        <bpmn:endEvent id="Event_1mlp" name="Return Downloaded File">
          <bpmn:extensionElements />
          <bpmn:incoming>Flow_0get4cm</bpmn:incoming>
        </bpmn:endEvent>
      </bpmn:subProcess>
      <bpmn:endEvent id="Event_0b60" name="Return collection of result files">
        <bpmn:extensionElements />
        <bpmn:incoming>Flow_0ixort9</bpmn:incoming>
      </bpmn:endEvent>
    </bpmn:subProcess>
    <bpmn:startEvent id="StartEvent_11" name="Start">
      <bpmn:extensionElements />
      <bpmn:outgoing>Flow_1w7dwe7</bpmn:outgoing>
    </bpmn:startEvent>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="ABBYY_Vantage_Download_Results">
      <bpmndi:BPMNShape id="Event_187s21t_di" bpmnElement="Event_187">
        <dc:Bounds x="952" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="961" y="205" width="20" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0g53xun_di" bpmnElement="ProcessingResults.DocumentsActivity" isExpanded="true">
        <dc:Bounds x="280" y="70" width="630" height="240" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0cshgm5_di" bpmnElement="Event_0cshg">
        <dc:Bounds x="322" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="300" y="205" width="85" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_01o3qa1_di" bpmnElement="Document.resultFilesActivity" isExpanded="true">
        <dc:Bounds x="390" y="108" width="410" height="160" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1wqkll2_di" bpmnElement="Download_Result_File">
        <dc:Bounds x="540" y="140" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0exe0uv_di" bpmnElement="Event_0exe0">
        <dc:Bounds x="452" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="432" y="205" width="79" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1mlp0ch_di" bpmnElement="Event_1mlp">
        <dc:Bounds x="692" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="671" y="205" width="82" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0get4cm_di" bpmnElement="Flow_0get4cm">
        <di:waypoint x="640" y="180" />
        <di:waypoint x="692" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1vxn1nt_di" bpmnElement="Flow_1vxn1nt">
        <di:waypoint x="488" y="180" />
        <di:waypoint x="540" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Event_0b60704_di" bpmnElement="Event_0b60">
        <dc:Bounds x="832" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="812" y="205" width="82" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0ixort9_di" bpmnElement="Flow_0ixort9">
        <di:waypoint x="800" y="180" />
        <di:waypoint x="832" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ytod6p_di" bpmnElement="Flow_0ytod6p">
        <di:waypoint x="358" y="180" />
        <di:waypoint x="390" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_11">
        <dc:Bounds x="172" y="162" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="178" y="205" width="24" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0isrmz3_di" bpmnElement="Flow_0isrmz3">
        <di:waypoint x="910" y="180" />
        <di:waypoint x="952" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1w7dwe7_di" bpmnElement="Flow_1w7dwe7">
        <di:waypoint x="208" y="180" />
        <di:waypoint x="280" y="180" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
